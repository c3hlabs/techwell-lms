<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techwell Master Board | V3.2 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --tech-blue: #0ea5e9; --tech-dark: #0f172a; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; transition: 0.3s; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .canvas-container { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border-radius: 8px; overflow: hidden; position: relative; }
        .active-tool { background-color: var(--tech-blue) !important; color: white !important; }
        #shape-search-overlay, #project-overlay { display: none; backdrop-filter: blur(10px); z-index: 100; position: absolute; inset: 0; }
        
        .asset-card { position: relative; }
        .asset-delete-btn { 
            position: absolute; top: -5px; right: -5px; 
            background: #ef4444; color: white; border-radius: 50%; 
            width: 20px; height: 20px; display: flex; 
            align-items: center; justify-content: center; font-size: 10px;
            opacity: 0; transition: 0.2s; z-index: 10;
        }
        .asset-card:hover .asset-delete-btn { opacity: 1; }
    </style>
</head>
<body class="h-screen flex flex-col" id="app-body">

    <header class="bg-white border-b px-6 py-3 flex justify-between items-center z-50">
        <div class="flex items-center gap-4">
            <div class="flex flex-col border-l-4 border-sky-500 pl-3">
                <h1 class="text-xl font-black text-slate-800 tracking-tighter uppercase">TECHWELL <span class="text-sky-500">Master</span></h1>
            </div>
            <button onclick="openProjectMenu()" class="ml-4 bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 transition">
                <i class="fas fa-folder-open mr-2"></i> PROJECTS
            </button>
        </div>

        <div class="flex items-center gap-6 bg-slate-100 px-4 py-1.5 rounded-2xl border">
            <div class="flex items-center gap-3">
                <input type="color" id="colorPicker" value="#0ea5e9" class="w-8 h-8 rounded-lg cursor-pointer border-none bg-transparent">
                <input type="range" id="brushSize" min="1" max="50" value="5" class="w-20 accent-sky-500">
            </div>
            <div class="flex items-center gap-2 border-l pl-4">
                <button onclick="setBoardBg('#ffffff')" class="w-6 h-6 rounded-full border bg-white shadow-sm" title="White"></button>
                <button onclick="setBoardBg('#1a1a1a')" class="w-6 h-6 rounded-full border bg-slate-900 shadow-sm" title="Black"></button>
                <button onclick="setBoardBg('#065f46')" class="w-6 h-6 rounded-full border bg-emerald-800 shadow-sm" title="Green"></button>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-slate-50 border px-4 py-1.5 rounded-2xl">
            <button onclick="undo()" class="p-2 hover:bg-white rounded-lg transition" title="Undo"><i class="fas fa-undo"></i></button>
            <button onclick="redo()" class="p-2 hover:bg-white rounded-lg transition" title="Redo"><i class="fas fa-redo"></i></button>
            <div class="flex items-center gap-3 px-3 border-l ml-2">
                <button onclick="changePage(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg"><i class="fas fa-chevron-left"></i></button>
                <span id="pageDisplay" class="text-xs font-black text-slate-600 uppercase">PAGE 1 / 1</span>
                <button onclick="changePage(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg"><i class="fas fa-chevron-right"></i></button>
                <button onclick="addNewPage()" class="ml-2 bg-sky-500 text-white w-7 h-7 rounded-full flex items-center justify-center hover:bg-sky-600 transition shadow-sm"><i class="fas fa-plus text-xs"></i></button>
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="exportImage()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-indigo-700">
                <i class="fas fa-download mr-2"></i>Download PNG
            </button>
            <button onclick="saveProject()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm">Save</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="w-20 bg-white border-r flex flex-col items-center py-6 gap-5 overflow-y-auto">
            <button onclick="setMode('draw')" id="btn-draw" class="active-tool p-4 rounded-2xl text-slate-400 hover:bg-slate-50 transition" title="Pencil"><i class="fas fa-pencil-alt text-xl"></i></button>
            <button onclick="setMode('erase')" id="btn-erase" class="p-4 rounded-2xl text-slate-400 hover:bg-slate-50 transition" title="Eraser"><i class="fas fa-eraser text-xl"></i></button>
            <button onclick="setMode('select')" id="btn-select" class="p-4 rounded-2xl text-slate-400 hover:bg-slate-50 transition" title="Select"><i class="fas fa-mouse-pointer text-xl"></i></button>
            <button onclick="deleteSelectedObject()" class="p-4 rounded-2xl text-red-400 hover:bg-red-50 transition" title="Delete Selected"><i class="fas fa-trash text-xl"></i></button>
            <div class="w-8 h-px bg-slate-100"></div>
            <button onclick="openShapeSearch()" class="p-4 rounded-2xl text-sky-500 bg-sky-50 hover:bg-sky-100 transition" title="Library"><i class="fas fa-th-large text-xl"></i></button>
            <button onclick="addText()" class="p-4 rounded-2xl text-slate-400 hover:bg-slate-50 transition" title="Text"><i class="fas fa-font text-xl"></i></button>
            <button onclick="document.getElementById('imgInput').click()" class="p-4 rounded-2xl text-slate-400 hover:bg-slate-50 transition" title="Upload Image"><i class="fas fa-image text-xl"></i></button>
            <input type="file" id="imgInput" class="hidden" accept="image/*" onchange="uploadImage(event)">
            <button onclick="deleteEntireWorkspace()" class="mt-auto p-4 text-red-300 hover:text-red-600 transition" title="Wipe Workspace"><i class="fas fa-refresh text-xl"></i></button>
        </aside>

        <main class="flex-1 relative flex items-center justify-center p-4">
            <div id="canvas-wrap" class="canvas-container bg-white border">
                <canvas id="mainCanvas"></canvas>
            </div>
        </main>

        <div id="project-overlay" class="flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                    <h2 class="text-xl font-bold uppercase tracking-tight">Project Gallery</h2>
                    <button onclick="closeProjectMenu()" class="text-white opacity-50 hover:opacity-100"><i class="fas fa-times"></i></button>
                </div>
                <div id="projectList" class="flex-1 overflow-y-auto p-6 grid grid-cols-1 gap-4 custom-scroll"></div>
            </div>
        </div>

        <div id="shape-search-overlay" class="flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                    <h2 class="text-2xl font-black">Resource Library</h2>
                    <button onclick="closeShapeSearch()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-4 border-b bg-white"><input type="text" id="shapeFilter" onkeyup="filterAssets()" placeholder="Search resources..." class="w-full px-6 py-3 rounded-xl ring-1 ring-slate-200"></div>
                <div class="flex-1 overflow-y-auto p-6 custom-scroll"><div id="shapeGrid" class="grid grid-cols-4 sm:grid-cols-6 gap-3"></div></div>
            </div>
        </div>
    </div>

    <script>
        let canvas, pages = [], currentPageIndex = 0;
        let history = [], redoStack = [], isLocked = false;
        let userImages = JSON.parse(localStorage.getItem('techwell_user_assets')) || [];

        const assetDB = [
            { name: 'Router', icon: 'fa-router', type: 'icon', code: 'f8da', category: 'network' },
            { name: 'Switch', icon: 'fa-network-wired', type: 'icon', code: 'f6ff', category: 'network' },
            { name: 'Server', icon: 'fa-server', type: 'icon', code: 'f233', category: 'devices' },
            { name: 'Firewall', icon: 'fa-shield-alt', type: 'icon', code: 'f3ed', category: 'security' },
            { name: 'Wi-Fi', icon: 'fa-wifi', type: 'icon', code: 'f1eb', category: 'connectivity' },
            { name: 'Satellite', icon: 'fa-satellite-dish', type: 'icon', code: 'f7c0', category: 'connectivity' },
            { name: 'Mobile Tower', icon: 'fa-tower-cell', type: 'icon', code: 'e585', category: 'connectivity' },
            { name: 'Internet', icon: 'fa-globe', type: 'icon', code: 'f0ac', category: 'connectivity' },
            { name: 'Ethernet', icon: 'fa-ethernet', type: 'icon', code: 'f796', category: 'connectivity' },
            { name: 'Link', icon: 'fa-link', type: 'icon', code: 'f0c1', category: 'connectivity' },
            { name: 'Laptop', icon: 'fa-laptop', type: 'icon', code: 'f109', category: 'devices' },
            { name: 'Desktop', icon: 'fa-desktop', type: 'icon', code: 'f390', category: 'devices' },
            { name: 'Mobile', icon: 'fa-mobile-screen-button', type: 'icon', code: 'f3fa', category: 'devices' },
            { name: 'Printer', icon: 'fa-print', type: 'icon', code: 'f02f', category: 'devices' },
            { name: 'User', icon: 'fa-user', type: 'icon', code: 'f007', category: 'users' },
            { name: 'Groups', icon: 'fa-user-group', type: 'icon', code: 'f500', category: 'users' },
            { name: 'Lock', icon: 'fa-lock', type: 'icon', code: 'f023', category: 'security' },
            { name: 'Key', icon: 'fa-key', type: 'icon', code: 'f084', category: 'security' },
            { name: 'Hacker', icon: 'fa-user-secret', type: 'icon', code: 'f21b', category: 'security' },
            { name: 'Shield Virus', icon: 'fa-shield-virus', type: 'icon', code: 'e06c', category: 'security' },
            { name: 'Cloud', icon: 'fa-cloud', type: 'icon', code: 'f0c2', category: 'network' },
            { name: 'Database', icon: 'fa-database', type: 'icon', code: 'f1c0', category: 'network' },
            { name: 'Hard Drive', icon: 'fa-hard-drive', type: 'icon', code: 'f0a0', category: 'devices' },
            { name: 'Nodes', icon: 'fa-circle-nodes', type: 'icon', code: 'e4e8', category: 'network' },
            { name: 'Rectangle', icon: 'fa-square', type: 'shape', code: 'f0c8' },
            { name: 'Circle', icon: 'fa-circle', type: 'shape', code: 'f111' },
            { name: 'Triangle', icon: 'fa-caret-up', type: 'shape', code: 'f0d8' },
            { name: 'Star', icon: 'fa-star', type: 'icon', code: 'f005' },
            { name: 'Smile', icon: 'fa-face-smile', type: 'icon', code: 'f118' },
            { name: 'Rocket', icon: 'fa-rocket', type: 'icon', code: 'f135' }
        ];

        window.onload = () => {
            initWorkspace();
            renderAssetLibrary();
            loadAutoSave();
            
            document.getElementById('colorPicker').oninput = (e) => {
                const active = canvas.getActiveObject();
                if (active && (active.type === 'i-text' || active.type === 'text')) {
                    active.set('fill', e.target.value);
                    canvas.renderAll();
                }
                if (canvas.isDrawingMode) setMode('draw');
            };

            document.getElementById('brushSize').oninput = (e) => {
                if(canvas.freeDrawingBrush) canvas.freeDrawingBrush.width = parseInt(e.target.value);
            };
        };

        function initWorkspace() {
            canvas = new fabric.Canvas('mainCanvas', { 
                width: window.innerWidth - 120, 
                height: window.innerHeight - 130, 
                backgroundColor: '#ffffff' 
            });
            setMode('draw');
            
            canvas.on('object:added', triggerUpdate);
            canvas.on('object:modified', triggerUpdate);
            canvas.on('object:removed', triggerUpdate);
        }

        function deleteSelectedObject() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                activeObjects.forEach(obj => canvas.remove(obj));
                canvas.discardActiveObject().renderAll();
            }
        }

        function triggerUpdate() { if(!isLocked) { saveHistory(); syncStorage(); } }

        function saveHistory() {
            history.push(JSON.stringify(canvas.toJSON(['backgroundColor'])));
            if(history.length > 50) history.shift();
            redoStack = [];
        }

        function undo() {
            if(history.length <= 1) return;
            isLocked = true;
            redoStack.push(history.pop());
            const previousState = JSON.parse(history[history.length - 1]);
            canvas.loadFromJSON(previousState, () => {
                canvas.renderAll();
                isLocked = false;
                syncStorage();
            });
        }

        function redo() {
            if(redoStack.length === 0) return;
            isLocked = true;
            const nextState = redoStack.pop();
            history.push(nextState);
            canvas.loadFromJSON(JSON.parse(nextState), () => {
                canvas.renderAll();
                isLocked = false;
                syncStorage();
            });
        }

        function setBoardBg(color) {
            canvas.setBackgroundColor(color, () => {
                canvas.renderAll();
                if(canvas.freeDrawingBrush && canvas.freeDrawingBrush.inverted) setMode('erase');
                triggerUpdate();
            });
        }

        function setMode(mode) {
            canvas.isDrawingMode = (mode !== 'select');
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('active-tool'));
            
            if(mode === 'draw') {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = document.getElementById('colorPicker').value;
                canvas.freeDrawingBrush.width = parseInt(document.getElementById('brushSize').value);
                document.getElementById('btn-draw').classList.add('active-tool');
            } else if(mode === 'erase') {
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
                canvas.freeDrawingBrush.color = canvas.backgroundColor;
                canvas.freeDrawingBrush.width = parseInt(document.getElementById('brushSize').value) * 2;
                canvas.freeDrawingBrush.inverted = true; 
                document.getElementById('btn-erase').classList.add('active-tool');
            } else {
                document.getElementById('btn-select').classList.add('active-tool');
            }
        }

        function addNewPage() {
            pages[currentPageIndex] = canvas.toJSON(['backgroundColor']);
            canvas.clear();
            canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
            pages.push(canvas.toJSON(['backgroundColor']));
            currentPageIndex = pages.length - 1;
            updatePageUI();
            triggerUpdate();
        }

        function changePage(dir) {
            const newIndex = currentPageIndex + dir;
            if(newIndex >= 0 && newIndex < pages.length) {
                pages