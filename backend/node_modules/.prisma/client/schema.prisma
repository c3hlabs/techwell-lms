// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= USER & AUTH =============

model User {
  id            String  @id @default(cuid())
  email         String  @unique
  password      String
  name          String
  role          Role    @default(STUDENT)
  avatar        String?
  phone         String?
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)
  permissions   Json? // Array of permission strings e.g. ["MANAGE_COURSES", "VIEW_FINANCE"]

  // Relations
  enrollments    Enrollment[]
  interviews     Interview[]
  lessonProgress LessonProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Phase 23: Community & Chat
  posts         ForumPost[]
  comments      ForumComment[]
  conversations Conversation[] @relation("UserConversations")
  sentMessages  Message[]
  payments      Payment[]
  certificates  Certificate[]
  reviews       Review[]

  // Support
  tickets            Ticket[]
  sentTicketMessages TicketMessage[]

  // Phase 25: Career
  employerProfile EmployerProfile?
  jobs            Job[] // Jobs posted by this user (if Employer)
  applications    JobApplication[] // Applications submitted by this user (if Student)

  // Relations: Tasks & Blogs
  assignedTasks Task[]        @relation("AssignedTo")
  createdTasks  Task[]        @relation("CreatedBy")
  blogPosts     BlogPost[]
  taskComments  TaskComment[]

  // ATS Relations
  conductedJobInterviews JobInterview[]
}

enum Role {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  STUDENT
  STAFF
  INSTITUTE_ADMIN
  EMPLOYER
}

// ============= LMS - COURSES =============

model Course {
  id            String     @id @default(cuid())
  title         String
  description   String
  thumbnail     String?
  category      String
  difficulty    Difficulty @default(BEGINNER)
  duration      Int        @default(0) // in hours
  price         Decimal    @default(0)
  discountPrice Decimal    @default(0)
  courseCode    String?    @unique
  jobRoles      Json? // Array of job roles e.g. ["Frontend Dev", "UI Engineer"]
  bannerUrl     String?
  averageRating Float      @default(0)
  instructorId  String
  isPublished   Boolean    @default(false)

  // Phase 19: Course-Interview Integration
  hasInterviewPrep Boolean @default(false)
  interviewPrice   Decimal @default(0)
  bundlePrice      Decimal @default(0)

  // Phase 24: Course Types
  courseType   CourseType @default(RECORDED)
  liveSchedule Json? // { startDate, endDate, sessions: [{date, time, duration, meetingUrl}] }
  hybridConfig Json? // { livePercentage, recordedModules, liveModules }

  // Phase 24: Deployment Workflow
  publishStatus        PublishStatus @default(DRAFT)
  publishedAt          DateTime?
  reviewNotes          String?
  submittedForReviewAt DateTime?

  // Relations
  modules     Module[]
  enrollments Enrollment[]
  payments    Payment[]
  reviews     Review[]
  liveClasses LiveClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([title, instructorId])
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseType {
  RECORDED // Pre-recorded video lessons
  LIVE // Scheduled live sessions
  HYBRID // Mix of live + recorded
}

enum PublishStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  ARCHIVED
}

model Module {
  id          String  @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, orderIndex])
}

model Lesson {
  id       String  @id @default(cuid())
  moduleId String
  title    String
  content  String?
  videoUrl String?
  duration Int? // in seconds
  order    Int

  // Relations
  module   Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes  Quiz[]
  progress LessonProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Quiz {
  id            String  @id @default(cuid())
  lessonId      String
  question      String
  options       Json // Array of options
  correctAnswer String
  explanation   String?

  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Enrollment {
  id                 String           @id @default(cuid())
  userId             String
  courseId           String
  progress           Int              @default(0) // percentage
  status             EnrollmentStatus @default(ACTIVE)
  hasInterviewAccess Boolean          @default(false) // Phase 19: Bundle Access

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  enrolledAt  DateTime  @default(now())
  completedAt DateTime?

  @@unique([userId, courseId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

model LessonProgress {
  id             String   @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean  @default(false)
  timeSpent      Int      @default(0) // in seconds
  lastAccessedAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Review {
  id       String  @id @default(cuid())
  userId   String
  courseId String
  rating   Int // 1-5
  comment  String? @db.Text

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= INTERVIEW SYSTEM =============

model Interview {
  id             String     @id @default(cuid())
  userId         String
  domain         String // IT, Finance, Marketing, etc.
  company        String? // Google, Amazon, etc.
  role           String // SDE, Manager, etc.
  technology     String? // Added: Primary technology stack
  jobDescription String?
  resumeUrl      String?
  difficulty     Difficulty @default(INTERMEDIATE)
  panelCount     Int        @default(1)
  linkedCourseId String? // Phase 19: Link to specific course curriculum

  duration        Int      @default(30) // in minutes
  selectedAvatars String[] // Avatars selected for this session (Panel)

  status      InterviewStatus @default(SCHEDULED)
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions  InterviewQuestion[]
  responses  InterviewResponse[]
  evaluation InterviewEvaluation?

  createdAt DateTime @default(now())
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model InterviewQuestion {
  id          String       @id @default(cuid())
  interviewId String
  avatarId    String?
  question    String
  type        QuestionType
  order       Int

  // Relations
  interview Interview          @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  response  InterviewResponse?
}

enum QuestionType {
  TECHNICAL
  BEHAVIORAL
  SITUATIONAL
  HR
}

model InterviewResponse {
  id          String @id @default(cuid())
  interviewId String
  questionId  String @unique

  transcript String?
  videoUrl   String?
  audioUrl   String?
  duration   Int? // in seconds

  // Relations
  interview Interview         @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  question  InterviewQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  respondedAt DateTime @default(now())
}

model InterviewEvaluation {
  id          String @id @default(cuid())
  interviewId String @unique

  overallScore       Int // 0-100
  technicalScore     Int
  communicationScore Int
  confidenceScore    Int
  starMethodScore    Int

  strengths       Json // Array of strings
  weaknesses      Json // Array of strings
  recommendations Json // Array of strings

  aiInsights String?

  // Relations
  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ============= AVATARS =============

model Avatar {
  id          String  @id @default(cuid())
  name        String
  role        String // Interviewer type
  personality String // Friendly, Strict, etc.
  avatarUrl   String
  voiceId     String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
}

// ============= ADMIN & AI TRAINING =============

model KnowledgeBase {
  id             String  @id @default(cuid())
  domain         String // e.g., "Frontend", "Backend"
  role           String? // e.g., "React Developer"
  question       String  @db.Text
  beginnerAnswer String  @db.Text
  mediumAnswer   String  @db.Text
  hardAnswer     String  @db.Text

  status    KnowledgeStatus @default(PUBLISHED)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

enum KnowledgeStatus {
  DRAFT
  PUBLISHED
}

model SystemPrompt {
  id       String  @id @default(cuid())
  role     String  @unique // e.g., "Interviewer_Technical", "Interviewer_HR"
  prompt   String  @db.Text
  isActive Boolean @default(true)

  updatedAt DateTime @updatedAt
}

// ============= PAYMENTS =============

model Payment {
  id        String  @id @default(cuid())
  orderId   String  @unique // Razorpay Order ID
  paymentId String? @unique // Razorpay Payment ID
  signature String?

  amount   Float
  currency String @default("INR")
  status   String @default("PENDING") // PENDING, SUCCESS, FAILED

  userId   String
  user     User   @relation(fields: [userId], references: [id])
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= COMMUNITY: FORUM =============

model ForumCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  slug        String  @unique
  icon        String? // URL or Icon name

  posts ForumPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ForumPost {
  id      String @id @default(cuid())
  title   String
  content String @db.Text
  slug    String @unique

  authorId   String
  categoryId String

  likes    Int     @default(0)
  views    Int     @default(0)
  isPinned Boolean @default(false)
  isSolved Boolean @default(false)

  // Relations
  author   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category ForumCategory  @relation(fields: [categoryId], references: [id])
  comments ForumComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ForumComment {
  id      String @id @default(cuid())
  content String @db.Text

  postId   String
  authorId String
  parentId String? // For nested replies (optional)

  isSolution Boolean @default(false)
  likes      Int     @default(0)

  // Relations
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User      @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= COMMUNITY: CHAT =============

model Conversation {
  id      String  @id @default(cuid())
  name    String? // Group name (optional)
  isGroup Boolean @default(false)

  // Relations
  participants User[]    @relation("UserConversations")
  messages     Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Message {
  id             String @id @default(cuid())
  conversationId String
  senderId       String
  content        String @db.Text

  readBy Json? // Array of userIds who read the message

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ============= CERTIFICATE SYSTEM =============

model Certificate {
  id           String @id @default(cuid())
  uniqueId     String @unique // Format: CERT-2026-00001
  userId       String
  courseId     String
  enrollmentId String

  // Certificate Details
  studentName    String
  courseName     String
  courseCategory String?
  issueDate      DateTime  @default(now())
  expiryDate     DateTime?
  templateId     String?

  // Signatures
  signatureUrl   String?
  signatoryName  String?
  signatoryTitle String?

  // Verification
  verificationUrl String?
  isValid         Boolean @default(true)

  // Grade/Score
  grade String?
  score Float?

  // Relations
  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  template CertificateTemplate? @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CertificateTemplate {
  id          String  @id @default(cuid())
  name        String
  description String?
  designUrl   String // Template image URL
  previewUrl  String? // Thumbnail preview
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)

  // Layout Settings
  layout Json? // { namePosition, datePosition, signaturePosition, etc }

  // Relations
  certificates Certificate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CertificateSettings {
  id          String @id @default(cuid())
  instituteId String @unique @default("default")

  // ID Format Settings
  prefix          String  @default("CERT")
  yearInId        Boolean @default(true)
  sequenceDigits  Int     @default(5)
  currentSequence Int     @default(0)

  // Signature Settings
  defaultSignatureUrl   String?
  defaultSignatoryName  String  @default("Director")
  defaultSignatoryTitle String  @default("Academic Director")

  // Position Settings (NEW)
  signaturePosition String  @default("bottom-center") // top-left, top-center, top-right, bottom-left, bottom-center, bottom-right
  logoPosition      String  @default("header") // header, footer, watermark, top-left, top-right
  logoSize          String  @default("medium") // small, medium, large
  signatureSize     String  @default("medium") // small, medium, large
  borderStyle       String  @default("classic") // classic, modern, minimal, elegant, none
  backgroundUrl     String? // Custom background image

  // Validity
  defaultValidityMonths Int? // null = no expiry

  // Branding
  instituteName    String  @default("TechWell Academy")
  instituteLogoUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= AI CONFIGURATION =============

model AIProvider {
  id        String  @id @default(cuid())
  name      String // OpenAI, Gemini, Claude, Anthropic
  provider  String // OPENAI, GOOGLE, ANTHROPIC, CUSTOM
  apiKey    String // Encrypted API key
  model     String // gpt-4, gemini-pro, claude-3, etc.
  endpoint  String? // Custom endpoint URL
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Usage Tracking
  usageLimit   Int? // Monthly token/request limit
  currentUsage Int      @default(0)
  lastResetAt  DateTime @default(now())

  // Settings
  temperature Float @default(0.7)
  maxTokens   Int   @default(2048)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AIUsageLog {
  id         String  @id @default(cuid())
  providerId String
  userId     String?
  feature    String // Q&A_GENERATION, INTERVIEW, COURSE_CREATION, etc.
  tokensUsed Int
  promptHash String? // For caching

  createdAt DateTime @default(now())
}

// ============= VIDEO CONFERENCING =============

model VideoIntegration {
  id       String @id @default(cuid())
  platform String // ZOOM, GOOGLE_MEET, MS_TEAMS
  name     String // Display name

  // OAuth/API Credentials
  clientId     String?
  clientSecret String?
  apiKey       String?
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?

  // Settings
  isActive   Boolean @default(false)
  webhookUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LiveClass {
  id          String  @id @default(cuid())
  courseId    String
  title       String
  description String?

  // Meeting Details
  platform    String // ZOOM, GOOGLE_MEET, MS_TEAMS, CUSTOM
  meetingLink String?
  meetingId   String?
  password    String?

  // Schedule
  scheduledAt DateTime
  duration    Int // in minutes
  timezone    String   @default("Asia/Kolkata")

  // Status
  status    LiveClassStatus @default(SCHEDULED)
  startedAt DateTime?
  endedAt   DateTime?

  // Recording
  recordingUrl      String?
  recordingPassword String?

  // Host Info
  hostId   String?
  hostName String?

  // Relations
  course Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LiveClassStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

// ============= CRM: LEADS & TASKS =============

model Lead {
  id    String  @id @default(cuid())
  name  String
  email String?
  phone String?

  // Demographics (For Analytics)
  college       String?
  qualification String?
  dob           DateTime?
  location      String? // City/State
  gender        String?

  source String // Website, Referral, LinkedIn, Google Ads, etc.
  status LeadStatus @default(NEW)

  notes      String? @db.Text
  assignedTo String? // User ID of sales rep

  // Marketing Metadata (Phase 19)
  platform   String? // META, GOOGLE_GMB, JUSTDIAL, WEBSITE
  campaignId String?
  adGroupId  String?
  adId       String?
  formId     String?

  // Relations
  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MarketingIntegration {
  id       String @id @default(cuid())
  platform String // META, GOOGLE_GMB, JUSTDIAL
  name     String

  // Auth
  accessToken  String? // Page Access Token for Meta
  refreshToken String?
  accountId    String? // Ad Account ID or Location ID
  pageId       String? // Facebook Page ID

  // Settings
  isActive      Boolean @default(false)
  webhookSecret String? // Verify incoming webhooks

  lastSyncAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model EmailIntegration {
  id       String  @id @default(cuid())
  provider String // SMTP, EMAILJS, SENDGRID, AWS_SES
  name     String? // "Marketing SMTP" or "Transactional EmailJS"

  // SMTP Fields
  host      String?
  port      Int?
  user      String?
  pass      String?
  secure    Boolean @default(true)
  fromEmail String?

  // API Fields (EmailJS / SendGrid)
  serviceId  String? // EmailJS Service ID
  templateId String? // EmailJS Template ID (Default)
  publicKey  String? // EmailJS Public Key
  privateKey String? // EmailJS Private Key
  apiKey     String? // SendGrid API Key

  isActive  Boolean  @default(false)
  updatedAt DateTime @updatedAt
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  QUALIFIED
  CONVERTED
  LOST
}

model Task {
  id          String  @id @default(cuid())
  title       String
  description String?

  status   TaskStatus @default(PENDING)
  priority Priority   @default(MEDIUM)
  dueDate  DateTime?

  assignedTo String?
  assignee   User?   @relation("AssignedTo", fields: [assignedTo], references: [id])
  createdBy  String?
  creator    User?   @relation("CreatedBy", fields: [createdBy], references: [id])

  // Relations
  leadId   String?
  lead     Lead?         @relation(fields: [leadId], references: [id])
  comments TaskComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TaskComment {
  id      String @id @default(cuid())
  content String

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model BlogPost {
  id         String  @id @default(cuid())
  title      String
  slug       String  @unique
  content    String  @db.Text
  summary    String? @db.Text
  coverImage String?

  status BlogStatus @default(DRAFT)
  tags   Json? // Array of strings

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum BlogStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  ARCHIVED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============= SUPPORT SYSTEM =============

model Ticket {
  id          String         @id @default(cuid())
  subject     String
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    TicketCategory @default(GENERAL)

  // Relations
  userId        String
  user          User    @relation(fields: [userId], references: [id])
  assignedTo    String? // ID of admin/staff assigned
  internalNotes String? @db.Text

  messages TicketMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketMessage {
  id            String  @id @default(cuid())
  message       String
  attachmentUrl String?
  isStaffReply  Boolean @default(false)

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  GENERAL
  TECHNICAL
  BILLING
  COURSE_CONTENT
  FEATURE_REQUEST
}

// ============= PAYMENT CONFIGURATION =============

model PaymentConfig {
  id String @id @default(cuid())

  // Razorpay
  razorpayKeyId     String?
  razorpayKeySecret String?

  // Stripe
  stripePublishableKey String?
  stripeSecretKey      String?

  // Settings
  activeGateway Gateway @default(RAZORPAY)
  currency      String  @default("INR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Gateway {
  RAZORPAY
  STRIPE
  NONE
}

model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Float
  category    String // Salary, Rent, Softwares, etc.
  description String?
  date        DateTime @default(now())

  createdBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============= SYSTEM SETTINGS =============

model SystemSettings {
  id String @id @default("default") // Singleton pattern

  // General Branding
  platformName String  @default("TechWell Academy")
  supportEmail String  @default("support@techwell.com")
  logoUrl      String?
  faviconUrl   String?

  // Theme
  primaryColor String @default("#2563eb") // blue-600

  // Maintenance
  isMaintenanceMode Boolean @default(false)

  // Contact Info
  address String?
  phone   String?

  updatedAt DateTime @updatedAt
}

// ============= CAREER SYSTEM =============

model EmployerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName String
  website     String?
  description String? @db.Text
  logo        String?
  location    String?
  industry    String?
  companySize String?

  status            EmployerStatus @default(PENDING)
  documentsVerified Boolean        @default(false)
  verificationNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Job {
  id           String  @id @default(cuid())
  title        String
  description  String  @db.Text
  requirements String? @db.Text
  location     String
  type         JobType @default(FULL_TIME)
  experience   String? // e.g. "0-1 years"
  salary       String? // e.g. "5-8 LPA"

  // New Fields
  skills        String? // Comma separated
  clientName    String? // For consultancies
  shift         String? // Day, Night, Rotational
  domain        String? // IT, Finance, etc.
  qualification String?

  // Relations
  employerId String
  employer   User   @relation(fields: [employerId], references: [id])

  applications JobApplication[]

  status      JobStatus @default(DRAFT)
  publishedAt DateTime?
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobApplication {
  id String @id @default(cuid())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id])

  // Applicant Info
  applicantId String? // Optional for external candidates
  applicant   User?   @relation(fields: [applicantId], references: [id])

  // Source Tracking (CRITICAL)
  source CandidateSource @default(INTERNAL)

  // External Candidate Details
  externalName  String?
  externalEmail String?
  externalPhone String?

  resumeUrl   String?
  coverLetter String? @db.Text

  // ATS & Scoring
  // Hidden field for storing parsed resume text for searching/scoring
  resumeParsedText String? @db.Text
  atsScore         Float   @default(0) // Match percentage (0-100)

  status        ApplicationStatus @default(APPLIED)
  statusHistory Json? // Array of { status, updatedBy, timestamp, notes }

  // Relations
  interviews JobInterview[]
  emailLogs  EmailLog[]
  auditLogs  AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint only applies if applicantId is present
  // For external, we might want unique on (jobId, externalEmail)
  @@unique([jobId, applicantId])
}

enum EmployerStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobType {
  FULL_TIME
  PART_TIME
  INTERNSHIP
  CONTRACT
  FREELANCE
}

enum CandidateSource {
  INTERNAL // Techwell Students
  EXTERNAL // Outside Applicants
}

enum JobStatus {
  DRAFT
  OPEN
  PUBLISHED
  PAUSED
  CLOSED
  ARCHIVED
}

enum ApplicationStatus {
  APPLIED
  VIEWED
  SCREENED
  SHORTLISTED
  INTERVIEW_PENDING
  INTERVIEW_SCHEDULED
  INTERVIEWED
  INTERVIEW_COMPLETED
  SELECTED
  APPOINTED // HIRED
  HIRED
  REJECTED
  REVIEWING
}

// ============= ATS & RECRUITMENT SYSTEM (NEW) =============

model JobInterview {
  id String @id @default(cuid())

  applicationId String
  application   JobApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Round Details
  roundName String // e.g. "Technical Round 1", "HR Round"
  roundType InterviewRoundType @default(TECHNICAL)

  // Schedule
  scheduledAt DateTime
  duration    Int      @default(30) // minutes
  meetingLink String?
  location    String? // For offline

  // Interviewer
  interviewerId String
  interviewer   User   @relation(fields: [interviewerId], references: [id])

  // Outcome
  status   InterviewStatus  @default(SCHEDULED)
  feedback String?          @db.Text
  score    Int? // 1-10 or 1-100
  result   InterviewResult? // PASS/FAIL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailLog {
  id String @id @default(cuid())

  // Context
  jobId         String?
  applicationId String?
  application   JobApplication? @relation(fields: [applicationId], references: [id])

  recipientEmail String
  recipientName  String?

  templateName String // e.g. "APPLICATION_RECEIVED"
  subject      String
  body         String @db.Text

  status EmailStatus @default(SENT)
  sentAt DateTime    @default(now())
  error  String?

  triggeredBy String? // User ID who triggered this
}

model AuditLog {
  id         String  @id @default(cuid())
  entityType String // JOB, APPLICATION, INTERVIEW, USER, SYSTEM
  entityId   String?
  action     String // CREATE, UPDATE, DELETE, STATUS_CHANGE, LOGIN, APPROVE

  // Request Context
  method    String? // POST, PUT, DELETE
  path      String? // /api/users/profile
  ipAddress String?
  userAgent String?

  // Data Changes
  oldValue Json?
  newValue Json?

  // For Application Context
  applicationId String?
  application   JobApplication? @relation(fields: [applicationId], references: [id])

  performedBy String
  details     Json? // { oldStatus: "APPLIED", newStatus: "SHORTLISTED", notes: "..." }

  timestamp DateTime @default(now())
}

model SavedFilter {
  id     String @id @default(cuid())
  name   String
  userId String // Recruiter ID
  page   String // "CANDIDATES" or "JOBS"

  config Json // { source: ["INTERNAL"], minExperience: 2 }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InterviewRoundType {
  SCREENING
  TECHNICAL
  MANAGERIAL
  HR
  FINAL
  OTHER
}

enum InterviewResult {
  PASSED
  FAILED
  ON_HOLD
}

enum EmailStatus {
  SENT
  FAILED
  QUEUED
}
